permissions:
  contents: read
  packages: write

name: Deploy App

on: [push]

jobs:

  Build:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Image
        run: |
          docker build -t ghcr.io/algnot/test-go-api:${{ github.sha }} .

      - name: Login to GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image
        run: |
          docker push ghcr.io/algnot/test-go-api:${{ github.sha }}

      - name: Tag latest
        run: |
          docker tag ghcr.io/algnot/test-go-api:${{ github.sha }} ghcr.io/algnot/test-go-api:latest
          docker push ghcr.io/algnot/test-go-api:latest

  Deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: Build

    steps:
      - uses: actions/checkout@v4

      - name: Render manifests
        run: |
          set -e
          TAG=${{ github.sha }}
          mkdir -p .rendered
          sed "s|__IMAGE_TAG__|${TAG}|g;" k8s/app.yaml > .rendered/app.yaml
          sed "s|__IMAGE_TAG__|${TAG}|g;" k8s/job.yaml > .rendered/job.yaml

      - name: Encode manifests as base64
        run: |
          set -e
          echo "APP_YAML_B64=$(base64 -w0 .rendered/app.yaml)" >> $GITHUB_ENV
          echo "JOB_YAML_B64=$(base64 -w0 .rendered/job.yaml)" >> $GITHUB_ENV

      - name: Apply to microk8s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          command_timeout: 30m
          envs: APP_YAML_B64,JOB_YAML_B64
          script: |
            set -e
            TAG=${{ github.sha }}
            
            echo "$APP_YAML_B64" | base64 -d > /tmp/app.yaml
            echo "JOB_YAML_B64" | base64 -d > /tmp/job.yaml
            
            wc -c /tmp/app.yaml
            head -n 5 /tmp/app.yaml
            
            microk8s kubectl apply -f /tmp/job.yaml
            microk8s kubectl -n test-go wait --for=condition=complete job/test-go-job --timeout=30m
            
            microk8s kubectl apply -f /tmp/app.yaml
